import { artForCard } from './art.js';
import { TYPES } from './constants.js';

async function loadJSON(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`Failed to load ${url}`);
  return res.json();
}

export async function buildDeck(theme){
  const [base, lifeGeneric, lifeSelf, lifeOpp, factionEvents, econ, econOpp] = await Promise.all([
    loadJSON('card_json/base_cards.json'),
    loadJSON('card_json/life_generic.json'),
    loadJSON('card_json/life_self.json'),
    loadJSON('card_json/life_opponent.json'),
    loadJSON('card_json/faction_events.json'),
    loadJSON('card_json/economy.json'),
    loadJSON('card_json/economy_opponent.json'),
  ]);

  const expand = (spec, defaultType) => {
    const out = [];
    for(const s of spec){
      const copies = Number.isFinite(s.copies) ? s.copies : 1;
      for(let i=0;i<copies;i++){
        const card = {
          name: s.name,
          type: s.type || defaultType,
          power: s.power || 0,
          scoreMod: s.scoreMod,
          bankMod: s.bankMod,
          target: s.target,
          bg: s.bg
        };
        card.art = artForCard(card, theme);
        out.push(card);
      }
    }
    return out;
  };

  const deck = [
    ...expand(base),                         // base already includes type
    ...expand(lifeGeneric, TYPES.LIFE),
    ...expand(lifeSelf, TYPES.LIFE),         // includes bg images
    ...expand(lifeOpp, TYPES.LIFE),
    ...expand(factionEvents, TYPES.LIFE),
    ...expand(econ, TYPES.ECONOMY),
    ...expand(econOpp, TYPES.ECONOMY),
  ];

  return deck.map((c,i)=>({id:i+1, ...c}));
}
